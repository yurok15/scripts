import os
from smtplib import SMTP
from email import message_from_bytes
from email.header import decode_header, Header

from aes.message import FixedMessage

RECIPIENT = 'test_recipient@intermedia.net'
SENDER = None

PATH = 'mails'

HOST = 'localhost'
PORT = 1025
THREADS = 1
FILES = ['test.eml']


def get_header(msg, name):
    d = msg[name]
    if isinstance(d, Header):
        d = decode_header(d)[0][0]
        return str(d, encoding='raw-unicode-escape')
    return d

for file_name in FILES or os.listdir(PATH):
    print(file_name)
    file_path = os.path.join(PATH, file_name)
    with open(file_path, 'br') as f:
        data = f.read()
    m = message_from_bytes(data, _class=FixedMessage)
    SENDER = SENDER or get_header(m, 'From')
    RECIPIENT = RECIPIENT or get_header(m, 'To')
    data = m.as_bytes()
    server = SMTP(HOST, PORT)
    server.command_encoding = 'utf-8'
    try:
        server.sendmail(SENDER, [RECIPIENT], data)
    except Exception:
        server.close()
        raise
    else:
        server.quit()
print('finish')
