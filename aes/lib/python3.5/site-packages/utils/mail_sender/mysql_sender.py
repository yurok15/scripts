from smtplib import SMTP
import pymysql

RECIPIENT = 'testMailBox8093@imqa-aesTest.qahostpilot.com'
SENDER = 'tinsleyHayden23@thislilpig.com'

HOST = 'devaesc-vx-1.devintermedia.net'
PORT = 1025

MYSQL_HOST = 'devmfrdb-vx-1.devintermedia.net'
MYSQL_PORT = 7001
MYSQL_DB = 'spamStopperTestData'
MYSQL_USER = 'AES'
MYSQL_PASSWORD = 'qqq111'

MAIL_ID = 'eicar_com_message_id'


def load_from_db(mail_id):
    connection = pymysql.connect(host=MYSQL_HOST,
                                 port=MYSQL_PORT,
                                 database=MYSQL_DB,
                                 user=MYSQL_USER,
                                 password=MYSQL_PASSWORD)
    try:
        with connection.cursor() as cursor:
            sql = "SELECT * FROM Mails where message_id = '%s'" % mail_id
            cursor.execute(sql)
            result = cursor.fetchone()
            record = {name[0]: result[i] for i, name in
                      enumerate(cursor.description)}
            return record['original_content']
    finally:
        connection.close()

data = load_from_db(MAIL_ID)
server = SMTP(HOST, PORT)
server.command_encoding = 'utf-8'
try:
    server.sendmail(SENDER, [RECIPIENT], data)
except Exception:
    server.close()
    raise
else:
    server.quit()
print('finish')
