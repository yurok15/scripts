import asyncio

from tests.core.runner import InboundAESTestService


async def test_cisco_dropped_connection(service_runner):
    async def cisco_client(loop, host, port):
        _, writer = await asyncio.open_connection(
            host=host,
            port=port,
            loop=loop,
        )
        writer.write_eof()
        await writer.drain()
        writer.close()
    calls = []

    def loop_exception_handler(*args):
        calls.append(args)
    runner = await service_runner(services={'aes': InboundAESTestService})
    runner.loop.set_exception_handler(loop_exception_handler)
    await cisco_client(runner.loop, runner['aes'].host, runner['aes'].port)
    assert len(calls) == 0
