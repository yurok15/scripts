from aes.core.statistics import prometheus
from aes.engines.base import BaseAVEngine
from .connector import CyrenNetworkSocket, CyrenUnixSocket


class CyrenAVEngine(BaseAVEngine):
    def _connection_factory(self, loop, config):
        kwargs = {
            'retry_attempts': config.get('retry_attempts', 3),
            'timeout': config.get('timeout', 60),
        }
        if 'host' in config:
            return CyrenNetworkSocket(
                loop,
                host=config['host'],
                port=config['port'],
                **kwargs)
        return CyrenUnixSocket(loop, unix_path=config.get('path'), **kwargs)

    @prometheus('aes_engine_cyren_av')
    async def process(self, envelope):
        return await super(CyrenAVEngine, self).process(envelope)
