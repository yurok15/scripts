import multiprocessing

DEBUG = False

AUTO_ENABLE_TEST_SERVICES = False

SERVICES = {
    'http': {
        'class': 'aes.services.HttpService',
        'host': '0.0.0.0',
        'port': 8000,
        'debug': False,
    },
    'inbound': {
        'class': 'aes.services.InboundSMTPService',
        'host': '0.0.0.0',
        'port': 1025,
        'ssl': None,
        'starttls': None,
        'helo_string':  'AESv2 Core Inbound',
        'data_size_limit': 0,
    },
    'outbound': {
        'class': 'aes.services.OutboundSMTPService',
        'host': '0.0.0.0',
        'port': 1026,
        'ssl': None,
        'starttls': None,
        'helo_string':  'AESv2 Core Outbound',
        'data_size_limit': 0,
    },
    'forks': {
        'class': 'aes.services.ForksService',
        'count': multiprocessing.cpu_count() + 1,
    },
    'prometheus': {'class': 'aes.services.PrometheusService'},
    'web': {'class': 'aes.services.WebService'},
    'analytics': {'class': 'aes.services.DirectLogstashService'},
}

ENGINES = {
    'clam_av': {
        'class': 'aes.engines.ClamAVEngine',
        'host': 'clamd',
        'port': 3310,
        'timeout': 60,
        'retry_attempts': 3,
        'limit': 10,
        'max_chunk_size': 1 * 1024 * 1024,
        'fast_plain_text': False,
        'cache_ttl': 60,
        'cache_lru': 100,
    },
    'cyren': {
        'class': 'aes.engines.CyrenEngine',
        'host': 'cyren',
        'port': 8088,
        'timeout': 60,
        'retry_attempts': 3,
        'limit': 10,
        'fast_plain_text': False,
        'spam_support': True,
        'cache_ttl': 60,
        'cache_lru': 100,
    },
    'cyren_av': {
        'class': 'aes.engines.CyrenAVEngine',
        'host': 'cyren_av',
        'port': 2705,
        'timeout': 60,
        'retry_attempts': 3,
        'limit': 10,
        'fast_plain_text': False,
        'cache_ttl': 60,
        'cache_lru': 100,
    },
    'sophos': {
        'class': 'aes.engines.SophosEngine',
        'host': 'sophos',
        'port': 4010,
        'timeout': 60,
        'retry_attempts': 3,
        'limit': 10,
        'fast_plain_text': False,
        'ignore_errors':
            ['020F', '0211', '0212', '021A', '021D', '0225', '0237'],
        'scan_errors':
            ['0202', '0208', '0209', '0210', '0213', '0215'],
    },
    'cloudmark': {'class': 'aes.engines.CloudmarkEngine'},
    'vade_retro': {
        'class': 'aes.engines.VadeRetroEngine',
        'host': 'vaderetro',
        'port': 11025,
        'timeout': 60,
        'retry_attempts': 3,
        'limit': 10,
        'cache_ttl': 60,
        'cache_lru': 100,
    },
    'mail_flow': {
        'class': 'aes.engines.MailFlowEngine',
        'source_ip_missed': [
            {
                'peer': [],
                'chain': []
            },
        ],
        'source_ip_present': [
            {
                'peer': [],
                'chain': []
            },
        ],
        'internal_hosts': [],
    }
}

FILTERS = [
    ('loop_checker', {
        'class': 'aes.filters.LoopChecker',
        'loop_limit': 3,
        'keep_timeout': 15 * 60,
    }),
    ('mail_flow', {
        'class': 'aes.filters.MailFlowFilter',
        'action': 'bypass',
    }),
    ('external_messages', {'class': 'aes.filters.ExternalMessageCheck'}),
    ('white_black', {'class': 'aes.filters.WhiteBlackFilter'}),
    ('tls_check', {'class': 'aes.filters.TLSCheckFilter'}),
    ('spf', {'class': 'aes.filters.SPFFilter'}),
    ('clamav', {'class': 'aes.filters.ClamAVFilter'}),
    # ('cyren', {'class': 'aes.filters.CyrenFilter'}),
    ('cyren', {'class': 'aes.filters.CyrenAVFilter'}),
    ('sophos', {'class': 'aes.filters.SophosFilter'}),
    ('vade_retro_av', {'class': 'aes.filters.VadeRetroAVFilter'}),
    ('spam', {'class': 'aes.filters.SpamFilter'}),
    ('marketing', {'class': 'aes.filters.MarketingFilter'}),
    ('attachments', {'class': 'aes.filters.AttachmentsFilter'}),
    ('phishing', {'class': 'aes.filters.PhishingFilter'}),
    ('url_protection', {
        'class': 'aes.filters.UrlProtectionFilter',
        'urlresolver_url': 'http://devaes-vx-1:80',
        'secret_key': 'lORSLyxpMKrLCwadEiNbCiUtTOwipGVC',
        'current_prefix': 'a',
        'action': 'admin_quarantine',
        'links_limit': 1000,
    }),
    ('content', {
        'class': 'aes.filters.ContentFilter',
        'headers': [
            'From', 'To', 'Subject', 'Reply-To', 'Content-Disposition'],
    }),
]

POLICY_SERVICE = {
    'url': "http://devaes-vx-1:3002",
    'pool_limit': 0,
    'timeout': 60,
    'ttl': 60,
    'lru': 100,
    'content_limit': 1024 * 1024 * 3,
    'secret_key': '0123456789ABCDEF0123456789ABCDEF',
}

DELIVERY = {
    'send': {
        'class': 'aes.delivery.NextHopDelivery',
    },
    'admin_quarantine': {
        'class': 'aes.delivery.AdminQuarantineDelivery',
        'command_encoding': 'utf-8',
    },
    'user_quarantine': {
        'class': 'aes.delivery.UserQuarantineDelivery',
        'command_encoding': 'utf-8',
    },
    'deny': {
        'class': 'aes.delivery.DeliveryService',
    },
    'ndr': {
        'class': 'aes.delivery.ndr.NDRDelivery',
        'starttls': None
    },
}

# Logging docs: https://docs.python.org/3.4/library/logging.config.html

LOGGING = {
    'version': 1,
    'disable_existing_loggers': False,
    'formatters': {
        'verbose': {
            'format': '%(name)s %(levelname)s %(asctime)s %(message)s '
                      '%(extra)s',
        },
        'simple': {
            'format': '%(name)s %(levelname)s %(message)s %(extra)s',
        },
    },
    'filters': {
        'user_context': {
            '()': 'aes.core.filters.ContextFilter',
        },
        'console_filter': {
            '()': 'aes.core.filters.ConsoleFilter',
        },
    },
    'handlers': {
        'null': {
            'level': 'DEBUG',
            'class': 'logging.FileHandler',
            'filename': 'ext://os.devnull',
        },
        'console': {
            'level': 'DEBUG',
            'class': 'logging.StreamHandler',
            'filters': ['console_filter'],
            'formatter': 'simple',
            'stream': 'ext://sys.stderr',
        },
        'file': {
            'level': 'DEBUG',
            'class': 'logging.FileHandler',
            'filename': 'logfile.log',
        },
        'logstash': {
            'level': 'DEBUG',
            'class': 'aes.services.analytics.logstash.LogstashClusterHandler',
            'filters': ['user_context'],
            'hosts': [('localhost', 11011)],
            'version': 1,
        },
    },
    'loggers': {
        'aiohttp.access': {
            'level': 'WARNING',
            'propagate': False,
        },
        'elasticsearch': {
            'level': 'ERROR'
        }
    },
    'root': {
        'handlers': ['console', 'logstash'],
        'level': 'DEBUG',
    },
}
