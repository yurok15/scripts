import uuid

from logstash.formatter import LogstashFormatterBase

from aes import __version__
from .analytics import get_user_context


class ContextFilter(LogstashFormatterBase):
    def __init__(self, message_type='Logstash', tags=None, fqdn=False):
        super(ContextFilter, self).__init__(
            message_type=message_type, tags=tags, fqdn=fqdn)
        self.version = __version__

    def filter(self, record):
        log_context = get_user_context()
        for name, value in log_context.items():
            setattr(record, 'usr_' + name, value)
        record.version = self.version
        if 'm_id' not in record.__dict__:
            record.m_id = str(uuid.uuid4())
        return True


class ConsoleFilter(ContextFilter):
    def filter(self, record):
        if not super(ConsoleFilter, self).filter(record):
            return False
        record.extra = self.get_extra_fields(record)
        if 'stack_info' in record.extra:
            del record.extra['stack_info']
        return True
